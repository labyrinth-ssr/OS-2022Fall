# OS Lab 1: Booting

本学期，我们将实现一个简单的操作系统内核。第一个实验里，我们的目标是引导系统进入`main`函数，输出 `Hello world!` ，以及了解这套流程是怎么完成的。

## 实验环境

本学期实验使用AArch64架构，推荐在服务器上进行，已为大家提供独立的容器和工具。

连接服务器的命令：

```shell
ssh root@10.176.34.211 -p 你的端口号
```

需要本地拥有ssh的私钥，Windows和Linux下都可运行，推荐使用VS Code的Remote插件进行连接。

容器有两个特殊的目录（挂载点）。`/share`目录只读，供所有同学共享，我们会在其中放置一些共享文件。`~/data`目录可读写，我们为你挂载了一块4.4T的硬盘，建议你在该目录下存储实验所用到的文件。

CPU、内存和硬盘资源是所有同学共享的，我们没有为大家设置使用配额，请注意合理使用资源。输入 `htop` 查看硬件资源的使用情况，q 键退出

在服务器上开发，可以参考下面指令初始化代码仓库，你也可以fork一份你自己的仓库

```bash
cd ~/data
# clone代码仓库
git clone https://github.com/FDUCSLG/OS-2022Fall-Fudan.git
cd OS-2022Fall-Fudan
# 切换到本实验分支
git checkout lab1
# 创建build目录用来进行后续的运行
mkdir -p build
cd build
cmake ..
make qemu 
```

之后每次运行只要在`build`目录下`cmake .. && make qemu`。

**`qemu` 的退出方法为： `Ctrl+A`，松开后按 `x`。**

每次发布新的lab后，可以参考下面指令更新代码仓库

```bash
# 拉取远端仓库
git fetch --all
# 提交你的更改
git add .
git commit -m "your commit message"
# 切换到新lab的分支
git checkout lab2
# 新建一个分支，用于开发
git checkout -b lab2-dev
# 引入你在上个lab的更改
git merge lab1-dev
```

如果合并发生冲突，请参考错误信息自行解决。

## AArch64

> AArch64等价于ARMv8的64位指令集。

本学期的教学OS将运行在AArch64架构下。

绝大多数代码都使用C语言完成，部分代码需要使用汇编语言编写，建议大家掌握AArch64汇编的下面内容

指令手册：[Arm Architecture Reference Manual Armv8, for A-profile architecture](https://developer.arm.com/documentation/ddi0487/gb)

* 各通用寄存器及其别名、函数调用约定、栈结构

* 算术、访存、跳转等基本汇编指令

## Booting

> 操作系统之获得控制权的两个要素：内核模式与优先引导

#### 内核模式

AArch64中有EL3、EL2、EL1、EL0四个特权级，我们的lab只使用EL1、EL0特权级。其中EL1就是运行操作系统的内核模式，EL0是用户模式，硬件保障了不同模式下程序运行的权限不同，从而让用户程序始终在操作系统的管理下。

#### 优先引导

我们在上学期的计组课程中已经学过，CPU上电时处于可以运行任何指令、访问任何内存的不受限制状态，并将PC设定为固定的值。在树莓派中，初始PC为0x80000。加载内核时，固件会将我们的内核代码复制到0x80000处，这样操作系统就占据了先机。

> 因为可以优先运行，操作系统在开机配置完成后确保自己掌握了整个系统的控制权

我们使用了链接器脚本控制内核入口（`_start`函数）刚好被链接在生成的内核文件的开头，所用的脚本可参见`linker.ld`。链接器脚本参考：[Linker Scripts](https://sourceware.org/binutils/docs/ld/Scripts.html)。用到的一些语法：

* `.` 被称为 location counter，代表了当前位置代码的实际上会运行在内存中的哪个地址。如 `. = 0xFFFF000000080000;` 代表我们告诉链接器内核的第一条指令运行在 0xFFFF000000080000。但事实上，我们一开始是运行在物理地址 0x80000（为什么仍能正常运行？），开启页表后，我们才会跳到高地址（虚拟地址），大部分代码会在那里完成。

* text 段中的第一行为 `KEEP(*(.text.boot))` 是指把 `start.S` 中我们自定义的 `.text.boot` 段放在 text 段的开头。`KEEP` 则是告诉链接器始终保留此段，否则编译器可能会将未用到的段优化掉。

* `PROVIDE(etext = .)` 声明了一个符号 `etext`（但并不会为其分配具体的内存空间，即在 C 代码中我们不能对其进行赋值），并将其地址设为当前的 location counter。这使得我们可以在汇编或 C 代码中得到内核各段（text/data/bss）的地址范围，我们在初始化 BSS 的时候需要用到这些符号。

我们不要求大家自行编写链接器脚本。

`_start`主要完成一些架构相关的初始化工作：唤醒所有CPU核，在EL3、EL2特权级下进行简单的配置，进入EL1特权级，使用`kernel_pt`开启虚拟地址，设置内核栈，最后跳转到`main`函数。

`kernel_pt`是`aarch64/kernel_pt.c`中预定义的页表，它基本上就是直接映射，映射关系为虚拟地址等于物理地址加上`0xffff0000_00000000`。`kernel_pt`还标记了一些用于MMIO的地址为`PTE_DEVICE`，提示cache需要对该地址特殊处理。关于页表的细节我们会在后续lab中介绍。

## .init section

在内核初始化时，需要调用很多模块的初始化函数。借助链接器脚本，我们可以将需要在初始化时调用的函数指针都放置到`.init`section中，内核初始化时遍历调用`.init`section中放置的所有函数指针，即可完成所有模块的初始化。

> 这个设计不适用于需要精确控制初始化顺序的情况。

## putchar

与之前在计组实验中做的类似，我们使用MMIO方式访问UART设备（字符设备），向固件设定的地址写一字节数据，即可输出一个字符。

为避免该操作被编译器优化影响，我们需要为地址加上`volatile`标记，以免编译器将其优化掉，并添加编译器屏障，以免编译器将其乱序处理，可参考`src/aarch64/intrinsic.h`:`device_put_u32()`。

## <u>作业与提交</u>

> `aarch64/intrinsic.h`提供了一些架构相关的代码。
> 
> `kernel/init.h`提供了一些初始化相关的代码。
> 
> `driver/uart.h`提供了一些uart相关的代码。
> 
> `common/string.h`提供了一些字符串相关的代码。

在`main.c`的`main`函数中添加代码，实现下面功能：

* 仅CPU0进入初始化流程，其余CPU直接退出。（我们没有实现电源管理功能，CPU退出可以参考提供的`arch_stop_cpu()`函数）

* 初始化`.bss`段，将其填充为`0`。（为什么？）

* 先后调用`do_early_init()`和`do_init()`函数。

* OS的`main`函数不能返回，请在完成前面步骤后让CPU0退出。

在`main.c`中使用`define_early_init`定义函数1，该函数将`hello[]`填充为`Hello world!`。

在`main.c`中使用`define_init`定义函数2，该函数通过uart输出`hello[]`的内容。

> 我们后续会直接为大家提供用法类似于`printf`的`printk`函数，无需大家自行对uart进行进一步封装。

如果一切顺利，你将看到`Hello world!`（怎么实现的？）

**提交：将实验报告提交到 elearning 上，格式为`学号-lab1.pdf`。本次实验中，<u>报告不计分</u>。<u>截止时间：9月16日 12:00</u>。逾期提交将扣除部分分数。**

报告中可以包括下面内容

* 代码运行效果展示

* 实现思路和创新点

* 思考题

* 对后续实验的建议

* 其他任何你想写的内容
  
  > ~~你甚至可以放一只可爱猫猫~~

报告中不应有大段代码的复制。如有使用本地环境进行使用的同学，请联系助教提交代码。使用服务器进行实验的同学，助教会在服务器上检查，不需要另外提交代码。

最后

提前祝大家中秋快乐

```
虎鲸> ٩( ๑╹ ꇴ╹)۶
熊猫> ٩(๑^o^๑)۶
青蛙> (｡･ω･｡)ﾉ♡
薮猫> ヽ（≧□≦）ノ
桶猫> └(^o^)┘
```
